<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-02 Sun 02:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Machine independent part of the simple Forth interpreter</title>
<meta name="author" content="Robert Kovacsics (rmk35)" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="../org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script type="text/javascript" src="../org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Machine independent part of the simple Forth interpreter</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9ae91d8">1. <span class="todo TODO">TODO</span> Forth</a>
<ul>
<li><a href="#orgeed5cac">1.1. <span class="todo TODO">TODO</span> Input</a>
<ul>
<li><a href="#org6093096">1.1.1. Words</a></li>
<li><a href="#org6935181">1.1.2. Numbers</a></li>
</ul>
</li>
<li><a href="#orgd8dbe63">1.2. <span class="todo TODO">TODO</span> Compiling</a></li>
<li><a href="#org5544b2d">1.3. <span class="todo TODO">TODO</span> REPL</a></li>
<li><a href="#org5cf8647">1.4. <span class="todo TODO">TODO</span> DOES&gt;</a></li>
<li><a href="#org9369497">1.5. <span class="todo TODO">TODO</span> Brave New Words</a></li>
<li><a href="#orgedcd9b7">1.6. <span class="todo TODO">TODO</span> Control Words</a></li>
<li><a href="#org1c8b105">1.7. <span class="todo TODO">TODO</span> Comments</a></li>
</ul>
</li>
<li><a href="#orgfdd8917">2. <span class="todo TODO">TODO</span> Change</a></li>
<li><a href="#orgadee56a">3. <span class="todo TODO">TODO</span> Testing</a></li>
<li><a href="#orgc4b9ace">4. <span class="todo TODO">TODO</span> After REPL</a></li>
<li><a href="#org41bc4b6">5. <span class="todo TODO">TODO</span> Forth Assembler</a>
<ul>
<li><a href="#org747731c">5.1. ;CODE</a></li>
</ul>
</li>
<li><a href="#org6832c89">6. <span class="todo TODO">TODO</span> Ideas</a></li>
<li><a href="#org10ef4c8">7. <span class="todo TODO">TODO</span> Naming</a></li>
<li><a href="#orgc555aea">8. <span class="todo TODO">TODO</span> Partial Recursive Functions (PRF) </a></li>
<li><a href="#orgb861b19">9. <span class="todo TODO">TODO</span> Terminal on host with simple-forth.c?</a></li>
</ul>
</div>
</div>

<div id="outline-container-org9ae91d8" class="outline-2">
<h2 id="org9ae91d8"><span class="section-number-2">1.</span> <span class="todo TODO">TODO</span> Forth</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgeed5cac" class="outline-3">
<h3 id="orgeed5cac"><span class="section-number-3">1.1.</span> <span class="todo TODO">TODO</span> Input</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org6093096" class="outline-4">
<h4 id="org6093096"><span class="section-number-4">1.1.1.</span> Words</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
TODO: backspace (or perhaps with a modified key?)
</p>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"LOWER"</span>, _
  <span class="org-keyword">.fw</span> DUP, LIT, L,'A', U_LESS_THAN
  <span class="org-keyword">.fw</span> OVER, LIT, L,'Z', U_GREATER_THAN
  <span class="org-keyword">.fw</span> OR, INVERT, ZBRANCH, L,(1f-.)
  <span class="org-keyword">.fw</span> LIT, L,32, ADD
<span class="org-function-name">1</span>:.fw EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: LOWER ( char -- char )
  dup char A U&lt; over char Z U&gt;
  or invert if 32 + then ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"CHAR\x3d"</span>, CHAR_EQUAL
  <span class="org-keyword">.fw</span> TWO_DUP, EQUAL, ZBRANCH, L,(1f-.)
  <span class="org-keyword">.fw</span> TWO_DROP, TRUE, EXIT
<span class="org-function-name">1</span>:.fw OVER, LIT, L,33, U_LESS_THAN
  <span class="org-keyword">.fw</span> OVER, LIT, L,33, U_LESS_THAN
  <span class="org-keyword">.fw</span> AND, ZBRANCH, L,(2f-.)
  <span class="org-keyword">.fw</span> TWO_DROP, TRUE, EXIT
<span class="org-function-name">2</span>:.fw LOWER, SWAP, LOWER, EQUAL
  <span class="org-keyword">.fw</span> ZBRANCH, L,(3f-.)
  <span class="org-keyword">.fw</span> TRUE, EXIT
<span class="org-function-name">3</span>:.fw FALSE, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: CHAR=' ( char char -- -1|0 )
  2dup = if 2drop true exit then
  over 33 U&lt; over 33 U&lt; and if 2drop true exit then
  lower swap lower = if true exit then
  false ;
</pre>
</div>
</td></tr></tbody></table>

<p>
TODO: transient region
</p>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"WORD\x27"</span>, WORD_NEW
  <span class="org-keyword">.fw</span> HERE, SWAP, LIT, L,0
<span class="org-function-name">WORD_SKIP</span>:
  <span class="org-keyword">.fw</span> DROP, KEY, TWO_DUP, CHAR_EQUAL
  <span class="org-keyword">.fw</span> INVERT, ZBRANCH, L,(WORD_SKIP-.)
<span class="org-function-name">WORD_LOOP</span>:
  <span class="org-keyword">.fw</span> DUP, C_COMMA, OVER, CHAR_EQUAL
  <span class="org-keyword">.fw</span> ZBRANCH, L,(WORD_CONT-.)
  <span class="org-keyword">.fw</span> DROP, CHAR_SIZE, NEGATE, ALLOT
  <span class="org-keyword">.fw</span> HERE, OVER, SUB, LIT, L,0, C_COMMA
  <span class="org-keyword">.fw</span> LIT, L,-1, OVER, SUB, ALLOT, EXIT
<span class="org-function-name">WORD_CONT</span>:
  <span class="org-keyword">.fw</span> KEY, BRANCH, L,(WORD_LOOP-.)
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: WORD' ( char "&lt;chars&gt;ccc&lt;char&gt;" -- c-addr u )
  here swap
  0 begin drop key 2dup char= until
  begin \ start char key
    dup C,
    over char= if \ start char
      drop char-size negate allot
      here over - 0 C,
      -1 over - allot exit
    then
    key
  again ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"WORD"</span>, WORD
  <span class="org-keyword">.fw</span> HERE, SWAP, CELL_SIZE, ALLOT,
  <span class="org-keyword">.fw</span> WORD_NEW, ROT, STORE
  <span class="org-keyword">.fw</span> CELL_SIZE, NEGATE, ALLOT
  <span class="org-keyword">.fw</span> CELL_SIZE, SUB, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: WORD ( char "&lt;chars&gt;ccc&lt;char&gt;" -- c-addr u )
  here swap cell-size allot
  word' rot \ c-addr u1 len-pos
  ! \ c-addr
  cell-size negate allot \ deallocate len
  cell-size - ; \ make addr point to len
</pre>
</div>
</td></tr></tbody></table>
</div>
</div>

<div id="outline-container-org6935181" class="outline-4">
<h4 id="org6935181"><span class="section-number-4">1.1.2.</span> Numbers</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
If the character is less than '0', or between '9' and 'A' (or 'Z' and
'a'), then it underflows, and will end up being greater than BASE.
</p>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"CHAR-&gt;DIGIT"</span>, CHAR_TO_DIGIT
  <span class="org-keyword">.fw</span> LIT, L,'0', SUB
  <span class="org-keyword">.fw</span> DUP, LIT, L,9, U_GREATER_THAN, ZBRANCH, L,(C_TO_D_END-.)
  <span class="org-keyword">.fw</span> LIT, L,('A'-'9'-1), SUB
  <span class="org-keyword">.fw</span> DUP, LIT, L,10, U_LESS_THAN, ZBRANCH, L,(C_TO_D_A-.)
  <span class="org-keyword">.fw</span> LIT, L,10, SUB
<span class="org-function-name">C_TO_D_A</span>:
  <span class="org-keyword">.fw</span> DUP, LIT, L,35, U_GREATER_THAN, ZBRANCH, L,(C_TO_D_END-.)
  <span class="org-keyword">.fw</span> LIT, L,32, SUB
  <span class="org-keyword">.fw</span> DUP, LIT, L,10, U_LESS_THAN, ZBRANCH, L,(C_TO_D_END-.)
  <span class="org-keyword">.fw</span> LIT, L,10, SUB
<span class="org-function-name">C_TO_D_END</span>:
  <span class="org-keyword">.fw</span> EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: CHAR-&gt;DIGIT ( char -- digit )
  char 0 -
  dup 9 U&gt; if
    7 - \ 9 : ; &lt; = &gt; ? @ A
    dup 10 U&lt; if 10 - then
    dup 35 U&gt; if
      32 - \ A-Z [ \ ] ^ _ ` a-z
      dup 10 U&lt; if 10 - then
    then
  then ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.data</span>
<span class="org-function-name">BASE_LOC</span>: .cell 10
<span class="org-keyword">.text</span>
<span class="org-keyword">.fdef</span> <span class="org-string">"BASE"</span>, BASE
  <span class="org-keyword">.fw</span> LIT, L,BASE_LOC, EXIT
<span class="org-keyword">.fdef</span> <span class="org-string">"DECIMAL"</span>, DECIMAL
  <span class="org-keyword">.fw</span> LIT, L,10, BASE, STORE, EXIT
<span class="org-keyword">.fdef</span> <span class="org-string">"&gt;NUMBER"</span>, TO_NUMBER
  <span class="org-keyword">.fw</span> OVER, ADD, DUP, TO_R, SWAP
  <span class="org-keyword">.fw</span> TWO_TO_R
<span class="org-function-name">TO_NUM_LOOP</span>:
  <span class="org-keyword">.fw</span> R_FETCH, C_FETCH, CHAR_TO_DIGIT, DUP
  <span class="org-keyword">.fw</span> BASE, FETCH, U_LESS_THAN
  <span class="org-keyword">.fw</span> ZBRANCH, L,(TO_NUM_ELSE-.)
  <span class="org-keyword">.fw</span> SWAP, BASE, FETCH, STAR, ADD
  <span class="org-keyword">.fw</span> BRANCH, L,(TO_NUM_NEXT-.)
<span class="org-function-name">TO_NUM_ELSE</span>:
  <span class="org-keyword">.fw</span> DROP, R_FETCH, TWO_R_DROP, R_FROM
  <span class="org-keyword">.fw</span> OVER, SUB,  EXIT
<span class="org-function-name">TO_NUM_NEXT</span>:
  <span class="org-keyword">.fw</span> R_FROM, LIT, L,1, ADD, TO_R
  <span class="org-keyword">.fw</span> TWO_R_FETCH, EQUAL
  <span class="org-keyword">.fw</span> ZBRANCH, L,(TO_NUM_LOOP-.)
  <span class="org-keyword">.fw</span> TWO_R_DROP
  <span class="org-keyword">.fw</span> R_FROM, LIT, L,0
  <span class="org-keyword">.fw</span> EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">variable BASE 10 BASE !
: &gt;NUMBER ( ud1 c-addr1 u1 -- ud2 c-addr2 u2 )
  over + dup &gt;R swap \ ud1 c-addr1+u1 c-addr1; R: c-addr1+u1
  do \ ud1; loops with  c-addr1 &lt;= I &lt; c-addr1+u1
    I C@ char-&gt;digit dup BASE @ U&lt; if \ ud1 digit
      swap BASE @ * +
    else \ ud2 digit
      drop I unloop R&gt; over - exit \ ud2 c-addr2 u2
    then
  loop
  R&gt; 0 ;
</pre>
</div>
</td></tr></tbody></table>

<p>
(We also need a way of converting signed numbers, and numbers in other
bases too, according to ยง3.4.1.3.
</p>

<div class="org-src-container">
<pre class="src src-forth">: NUMBER ( ud1 c-addr u1 -- number c-addr u2 )
  BASE @ &gt;R
  over @ ''' = if parse-char then
  over @ case
    '#' of 1 + decimal endof
    '$' of 1 + hex endof
    '%' of 1 + binary endof
  endcase
  dup 0 = if 1+ swap 1- exit ( to indicate that we failed to parse ) then
  over @ '-' = &gt;R
  R@ if 1+ then
  dup 0 = if 1+ swap -1 exit ( to indicate that we failed to parse ) then
  &gt;number
  rot R&gt; if negate then -rot
  R&gt; BASE !
  ;

: PARSE-CHAR ( ud1 c-addr u1 -- ud2 c-addr u2 )
  dup 3 = if
    drop 1+ dup C@ rot + swap 2 + 0
  then
  ;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd8dbe63" class="outline-3">
<h3 id="orgd8dbe63"><span class="section-number-3">1.2.</span> <span class="todo TODO">TODO</span> Compiling</h3>
<div class="outline-text-3" id="text-1-2">
<p>
See ยง3.4 of the <a href="https://www.taygeta.com/forth/dpans3.htm#3.4">ANSI Forth manual</a>.
</p>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"BL"</span>, BL
  <span class="org-keyword">.fw</span> LIT, L,' ', EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: BL ( -- char ) 32 ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"\x27"</span>, TICK
  <span class="org-keyword">.fw</span> BL, WORD_NEW, FIND_NEW, DROP, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: TICK ( "&lt;spaces&gt;name" -- xt )
  bl word' find' drop ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"OK"</span>, OK
  <span class="org-keyword">.fw</span> LIT, L,'O', EMIT, LIT, L,'k'
  <span class="org-keyword">.fw</span> EMIT, BL, EMIT, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: OK
  bl emit char O emit char k emit bl emit ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"ERROR"</span>, ERROR
  <span class="org-keyword">.fw</span> LIT, L,'E', EMIT, LIT, L,'r', EMIT
  <span class="org-keyword">.fw</span> LIT, L,'r', EMIT, BL, EMIT, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: ERROR
  char E emit char r emit char r emit bl emit ;
</pre>
</div>
</td></tr></tbody></table>
</div>
</div>

<div id="outline-container-org5544b2d" class="outline-3">
<h3 id="org5544b2d"><span class="section-number-3">1.3.</span> <span class="todo TODO">TODO</span> REPL</h3>
<div class="outline-text-3" id="text-1-3">
<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">TODO: Different interpretation modes</span>
<span class="org-keyword">.fdef</span> <span class="org-string">"COMPILE\x2c"</span>, COMPILE_COMMA
  <span class="org-keyword">.fw</span> COMMA, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">TODO
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"QUIT-FOUND"</span>, QUIT_FOUND
  <span class="org-keyword">.fw</span> NIP, LIT, L,-1, EQUAL, STATE
  <span class="org-keyword">.fw</span> FETCH, AND, ZBRANCH, L,(Q_F_EX-.)
  <span class="org-keyword">.fw</span> COMPILE_COMMA, BRANCH, L,(Q_F_END-.)
<span class="org-function-name">Q_F_EX</span>:
  <span class="org-keyword">.fw</span> EXECUTE
<span class="org-function-name">Q_F_END</span>:
  <span class="org-keyword">.fw</span> OK, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: QUIT_FOUND ( xt u -1|1 -- )
  nip -1 = state @ and if \ Compiling
    compiling, else execute then
  ok ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef1</span> <span class="org-string">"LITERAL"</span>, LITERAL, -1 <span class="org-comment-delimiter">/* </span><span class="org-comment">immediate */</span>
  <span class="org-keyword">.fw</span> LIT, LIT, COMMA
  <span class="org-keyword">.fw</span> COMMA, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: LITERAL ( x -- )
  ' lit compiling, , ; \ TODO
: LITERAL ['] lit , ; IMMEDIATE
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"QUIT-NOT-FOUND"</span>, QUIT_NOT_FOUND
  <span class="org-keyword">.fw</span> NROT, TO_NUMBER, LIT, L,0 <span class="org-comment-delimiter">/* </span><span class="org-comment">TODO: http://forth-standard.org/standard/usage#subsection.3.4.1.3 */</span>
  <span class="org-keyword">.fw</span> EQUAL, ZBRANCH, L,(Q_N_F_ELSE-.)
  <span class="org-keyword">.fw</span> DROP, STATE, FETCH, ZBRANCH, L,(Q_N_F_END-.)
  <span class="org-keyword">.fw</span> LITERAL
  <span class="org-keyword">.fw</span> BRANCH, L,(Q_N_F_END-.)
<span class="org-function-name">Q_N_F_ELSE</span>:
  <span class="org-keyword">.fw</span> TWO_DROP, ERROR, EXIT
<span class="org-function-name">Q_N_F_END</span>:
  <span class="org-keyword">.fw</span> OK, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: QUIT_NOT_FOUND ( c-addr u 0 -- )
  rot rot &gt;number 0 = if \ TODO negative numbers
    drop state @ if \ Compiling
      literal
    then
  else
    2drop error exit
  then
  ok ;
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"QUIT"</span>, QUIT
<span class="org-function-name">QUIT_LOOP</span>:
  <span class="org-keyword">.fw</span> BL, WORD_NEW, DUP, NROT
  <span class="org-keyword">.fw</span> FIND_NEW, ROT, SWAP
  <span class="org-keyword">.fw</span> DUP, ZBRANCH, L,(QUIT_N_F-.)
  <span class="org-keyword">.fw</span> QUIT_FOUND, BRANCH, L,(QUIT_LOOP-.)
<span class="org-function-name">QUIT_N_F</span>:
  <span class="org-keyword">.fw</span> QUIT_NOT_FOUND, BRANCH, L,(QUIT_LOOP-.)
  <span class="org-keyword">.fw</span> EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: QUIT ( -- )
  \ TODO: Set up value and return stacks
  begin
    bl word' dup rot rot \ u c-addr u
    find' rot swap \ c-addr u -1|0|1
    dup if quit_found else
	  quit_not_found then
    ok
  again ;
</pre>
</div>
</td></tr></tbody></table>
</div>
</div>

<div id="outline-container-org5cf8647" class="outline-3">
<h3 id="org5cf8647"><span class="section-number-3">1.4.</span> <span class="todo TODO">TODO</span> DOES&gt;</h3>
</div>
<div id="outline-container-org9369497" class="outline-3">
<h3 id="org9369497"><span class="section-number-3">1.5.</span> <span class="todo TODO">TODO</span> Brave New Words</h3>
<div class="outline-text-3" id="text-1-5">
<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef1</span> <span class="org-string">"["</span>, LBRAC,-1 <span class="org-comment-delimiter">/* </span><span class="org-comment">immediate */</span>
  <span class="org-keyword">.fw</span> LIT, L,0, STATE, STORE, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: [ false state ! IMMEDIATE
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef</span> <span class="org-string">"]"</span>, RBRAC
  <span class="org-keyword">.fw</span> LIT, L,-1, STATE, STORE, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">: ] true state !
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">// </span><span class="org-comment">TODO: SUBROUTINE .fdef "\x3a", COLON</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">TODO: SUBROUTINE   .fw CREATE</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">TODO: SUBROUTINE   .fw LIT, forth_interpreter, COMMA</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">TODO: SUBROUTINE   .fw LATEST, FETCH, HIDE</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">TODO: SUBROUTINE   .fw RBRAC, EXIT</span>
<span class="org-keyword">.fdef</span> <span class="org-string">"\x3a"</span>, COLON
  <span class="org-keyword">.fw</span> CREATE
  <span class="org-keyword">.fw</span> LATEST, FETCH, HIDE
  <span class="org-keyword">.fw</span> RBRAC, EXIT
  # TODO
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">
</pre>
</div>
</td></tr></tbody></table>

<table class="harmonica-table"><thead><tr><td>Assembly</td><td>Forth</td></tr></thead><tbody><tr><td>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fdef1</span> <span class="org-string">"\x3b"</span>, SEMICOLON, -1 <span class="org-comment-delimiter">/* </span><span class="org-comment">immediate */</span>
  <span class="org-keyword">.fw</span> LIT, L,EXIT, COMMA
  <span class="org-keyword">.fw</span> LATEST, FETCH, HIDE, LBRAC, EXIT
</pre>
</div>
</td><td>
<div class="org-src-container">
<pre class="src src-forth">TODO
</pre>
</div>
</td></tr></tbody></table>
</div>
</div>

<div id="outline-container-orgedcd9b7" class="outline-3">
<h3 id="orgedcd9b7"><span class="section-number-3">1.6.</span> <span class="todo TODO">TODO</span> Control Words</h3>
<div class="outline-text-3" id="text-1-6">
<p>
TODO explain, especially as we don't have comments yet
</p>
<ul class="org-ul">
<li>Note, not using compile, for [']</li>
<li>Note, literal defined previously
<ul class="org-ul">
<li>But ['] and LITERAL are very similar
<ul class="org-ul">
<li>Can we use LIT as ['], it only needs compilation semantics?
<ul class="org-ul">
<li>Not quite, it doesn't push XT, it pushes entry-&gt;interpreter
<ul class="org-ul">
<li>Perhaps swap the meaning of XT back?</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-forth">: POSTPONE ' compile, ; IMMEDIATE \ Can place elsewhere TODO
</pre>
</div>

<div class="org-src-container">
<pre class="src src-forth">: ['] lit lit , ' , ; IMMEDIATE
: IF
  ['] BRANCH, compile,
  HERE 0 , ; IMMEDIATE
: THEN
  HERE over - swap ! ; IMMEDIATE
: ELSE
  [']BRANCH, compile,
  HERE swap 0 ,
  HERE over - swap ! ; IMMEDIATE
</pre>
</div>

<div class="org-src-container">
<pre class="src src-forth">TODO TO TEST

: BEGIN
  HERE ; IMMEDIATE
: AGAIN
  [']BRANCH, compile,
  HERE - , ; IMMEDIATE
: UNTIL
  ['] BRANCH, compile,
  HERE - , ; IMMEDIATE
: WHILE
  ['] BRANCH, compile,
  HERE swap 0 , ; IMMEDIATE
: REPEAT
  [']BRANCH, ,
  HERE swap - ,
  HERE over swap - swap ! ; IMMEDIATE
</pre>
</div>

<div class="org-src-container">
<pre class="src src-forth">: DO
  2&gt;R ; IMMEDIATE
: ?DO
  2dup &lt;&gt; ['] BRANCH, compile, HERE
  2&gt;R ; IMMEDIATE
: LOOP
  ;
: +LOOP
  ;
: LEAVE
  TODO ; IMMEDIATE
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c8b105" class="outline-3">
<h3 id="org1c8b105"><span class="section-number-3">1.7.</span> <span class="todo TODO">TODO</span> Comments</h3>
<div class="outline-text-3" id="text-1-7">
<div class="org-src-container">
<pre class="src src-forth">: CHAR word' drop C@ ;
: [CHAR] char literal ; IMMEDIATE
</pre>
</div>

<div class="org-src-container">
<pre class="src src-forth">: \ begin key 10 = until ;
: ( begin key [char] ) = until ;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfdd8917" class="outline-2">
<h2 id="orgfdd8917"><span class="section-number-2">2.</span> <span class="todo TODO">TODO</span> Change</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="http://forth-standard.org/standard/doc">http://forth-standard.org/standard/doc</a>
</p>
<ul class="org-ul">
<li>Have a 'non-standard' but simpler Forth?</li>
<li>Forth requires max 31 chars for defn names, so we can simplify the dict</li>
<li>Document sec 4.1</li>
<li>Exns for ambiguous conds?</li>
</ul>
</div>
</div>
<div id="outline-container-orgadee56a" class="outline-2">
<h2 id="orgadee56a"><span class="section-number-2">3.</span> <span class="todo TODO">TODO</span> Testing</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><code>SOURCE-ID</code></li>
</ul>
</div>
</div>
<div id="outline-container-orgc4b9ace" class="outline-2">
<h2 id="orgc4b9ace"><span class="section-number-2">4.</span> <span class="todo TODO">TODO</span> After REPL</h2>
</div>

<div id="outline-container-org41bc4b6" class="outline-2">
<h2 id="org41bc4b6"><span class="section-number-2">5.</span> <span class="todo TODO">TODO</span> Forth Assembler</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org747731c" class="outline-3">
<h3 id="org747731c"><span class="section-number-3">5.1.</span> ;CODE</h3>
</div>
</div>
<div id="outline-container-org6832c89" class="outline-2">
<h2 id="org6832c89"><span class="section-number-2">6.</span> <span class="todo TODO">TODO</span> Ideas</h2>
<div class="outline-text-2" id="text-6">
<dl class="org-dl">
<dt>Server and client</dt><dd>Have the C implementation be a REPL server,
with separate messages, errors, and stack buffers?
<ul class="org-ul">
<li>Support for up/downloading 'images' (the dictionary?), and
perhaps replace raspbootin?</li>
</ul></dd>
<dt>DMA Forth</dt><dd>Do [[cite:runDMA][run-DMA] TODO this link</dd>
<dt><a href="#org10ef4c8">Naming</a></dt><dd>All the stack manipulation could be simplified by having
names.</dd>
<dt><a href="#orgfa8afc3">Partial Recursive Functions (PRF)</a></dt><dd>Perhaps could take inspiration
from the way composition is implemented there, in order to avoid
all the stack manipulation? This could be more in the Forth
spirit than <a href="#org10ef4c8">naming</a>.</dd>
<dt>Dereference-count</dt><dd>When a pointer gets dereferenced a lot, move
its pointee closer to that pointer (when doing mark&amp;move GC)? To
make it more likely to be in the cache (akin to
simulated-annealing in the connection machine).</dd>
<dt>Simple JIT</dt><dd>Inline all the non-recursive calls?</dd>
<dt>Debugger</dt><dd>Breakpoints and tracing?</dd>
<dt>Exception aspects</dt><dd>To decouple the 'textbook algorithm' from exception handling?</dd>
<dt>SD Card read/store</dt><dd>So that we can compile to/read from disk, and don't have to</dd>
<dt>Memory management</dt><dd>Simple bump allocator + GC? Might have to
modify @ and ! for GC?</dd>
</dl>
</div>
</div>

<div id="outline-container-org10ef4c8" class="outline-2">
<h2 id="org10ef4c8"><span class="section-number-2">7.</span> <span class="todo TODO">TODO</span> Naming</h2>
<div class="outline-text-2" id="text-7">
<p>
Plan is to extend forth to do naming, to make programs easier to
understand.
</p>

<p>
Doing this naively will probably result in a dynamic environment.
</p>

<p>
Something like
</p>
<div class="org-src-container">
<pre class="src src-forth">:fun REV-SUB ARG1 ARG2 =&gt; ARG2 ARG1 - ;
</pre>
</div>
<p>
which could get turned into the equivalent of
</p>
<div class="org-src-container">
<pre class="src src-forth">: REV-SUB
  2 PUSH-STACK-FRAME
  2 FROM-FRAME
  1 FROM-FRAME
  -
  POP-FRAME
  ;
</pre>
</div>
<p>
Also, I wonder if we need to redefine EXIT, for premature exits, or
perhaps have a trampoline take care of the push&amp;pop, like so:
</p>
<div class="org-src-container">
<pre class="src src-asm"><span class="org-keyword">.fw</span> SETUP
<span class="org-keyword">.fw</span> P
<span class="org-keyword">.fw</span> TEARDOWN
<span class="org-keyword">.fw</span> EXIT
<span class="org-function-name">P</span>:.fw BODY, ...
</pre>
</div>

<p>
This might even lead to optimisations, e.g. to
</p>
<div class="org-src-container">
<pre class="src src-forth">: REV-SUB
  SWAP -
  ;
</pre>
</div>

<p>
And arg-count checking, possibly only at runtime first, to make sure
we don't return multiple values or get too few arguments. Possibly
static-checking too?
</p>
</div>
</div>

<div id="outline-container-orgc555aea" class="outline-2">
<h2 id="orgc555aea"><span class="section-number-2">8.</span> <span class="todo TODO">TODO</span> Partial Recursive Functions (PRF) <a id="orgfa8afc3"></a></h2>
<div class="outline-text-2" id="text-8">
<p>
Perhaps turn something like
</p>
<div class="org-src-container">
<pre class="src src-forth">\ FOO ( A B C -- V W )
\ BAR ( E F -- X )
\ BAZ ( V W X -- M N O )
{ FOO , , BAR } BAZ
</pre>
</div>
<p>
into
</p>
<div class="org-src-container">
<pre class="src src-forth">FOO &gt;R
&gt;R \ from the empty
BAR &gt;R
R&gt; R&gt; R&gt;
BAZ
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb861b19" class="outline-2">
<h2 id="orgb861b19"><span class="section-number-2">9.</span> <span class="todo TODO">TODO</span> Terminal on host with simple-forth.c?</h2>
<div class="outline-text-2" id="text-9">
<p>
First, define a protocol
</p>
<ul class="org-ul">
<li>0 n char0 &#x2026; charn ( send n chars )</li>
<li>?</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Robert Kovacsics (rmk35)</p>
<p class="date">Created: 2022-01-02 Sun 02:12</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
